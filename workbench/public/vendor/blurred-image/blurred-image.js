(()=>{var V=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","#","$","%","*","+",",","-",".",":",";","=","?","@","[","]","^","_","{","|","}","~"],y=t=>{let e=0;for(let a=0;a<t.length;a++){let i=t[a],s=V.indexOf(i);e=e*83+s}return e},w=(t,e)=>{var a="";for(let i=1;i<=e;i++){let s=Math.floor(t)/Math.pow(83,e-i)%83;a+=V[Math.floor(s)]}return a},g=t=>{let e=t/255;return e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)},f=t=>{let e=Math.max(0,Math.min(1,t));return e<=.0031308?Math.trunc(e*12.92*255+.5):Math.trunc((1.055*Math.pow(e,.4166666666666667)-.055)*255+.5)},_=t=>t<0?-1:1,b=(t,e)=>_(t)*Math.pow(Math.abs(t),e),E=class extends Error{constructor(t){super(t),this.name="ValidationError",this.message=t}},C=t=>{if(!t||t.length<6)throw new E("The blurhash string must be at least 6 characters");let e=y(t[0]),a=Math.floor(e/9)+1,i=e%9+1;if(t.length!==4+2*i*a)throw new E(`blurhash length mismatch: length is ${t.length} but it should be ${4+2*i*a}`)};var P=t=>{let e=t>>16,a=t>>8&255,i=t&255;return[g(e),g(a),g(i)]},A=(t,e)=>{let a=Math.floor(t/361),i=Math.floor(t/19)%19,s=t%19;return[b((a-9)/9,2)*e,b((i-9)/9,2)*e,b((s-9)/9,2)*e]},G=(t,e,a,i)=>{C(t),i=i|1;let s=y(t[0]),l=Math.floor(s/9)+1,d=s%9+1,m=(y(t[1])+1)/166,n=new Array(d*l);for(let r=0;r<n.length;r++)if(r===0){let h=y(t.substring(2,6));n[r]=P(h)}else{let h=y(t.substring(4+r*2,6+r*2));n[r]=A(h,m*i)}let o=e*4,u=new Uint8ClampedArray(o*a);for(let r=0;r<a;r++)for(let h=0;h<e;h++){let c=0,p=0,I=0;for(let v=0;v<l;v++)for(let M=0;M<d;M++){let k=Math.cos(Math.PI*h*M/e)*Math.cos(Math.PI*r*v/a),R=n[M+v*d];c+=R[0]*k,p+=R[1]*k,I+=R[2]*k}let H=f(c),q=f(p),B=f(I);u[4*h+0+r*o]=H,u[4*h+1+r*o]=q,u[4*h+2+r*o]=B,u[4*h+3+r*o]=255}return u},x=G,L=4,z=(t,e,a,i)=>{let s=0,l=0,d=0,m=e*L;for(let o=0;o<e;o++){let u=L*o;for(let r=0;r<a;r++){let h=u+r*m,c=i(o,r);s+=c*g(t[h]),l+=c*g(t[h+1]),d+=c*g(t[h+2])}}let n=1/(e*a);return[s*n,l*n,d*n]},$=t=>{let e=f(t[0]),a=f(t[1]),i=f(t[2]);return(e<<16)+(a<<8)+i},O=(t,e)=>{let a=Math.floor(Math.max(0,Math.min(18,Math.floor(b(t[0]/e,.5)*9+9.5)))),i=Math.floor(Math.max(0,Math.min(18,Math.floor(b(t[1]/e,.5)*9+9.5)))),s=Math.floor(Math.max(0,Math.min(18,Math.floor(b(t[2]/e,.5)*9+9.5))));return a*19*19+i*19+s},U=(t,e,a,i,s)=>{if(i<1||i>9||s<1||s>9)throw new E("BlurHash must have between 1 and 9 components");if(e*a*4!==t.length)throw new E("Width and height must match the pixels array");let l=[];for(let r=0;r<s;r++)for(let h=0;h<i;h++){let c=h==0&&r==0?1:2,p=z(t,e,a,(I,H)=>c*Math.cos(Math.PI*h*I/e)*Math.cos(Math.PI*r*H/a));l.push(p)}let d=l[0],m=l.slice(1),n="",o=i-1+(s-1)*9;n+=w(o,1);let u;if(m.length>0){let r=Math.max(...m.map(c=>Math.max(...c))),h=Math.floor(Math.max(0,Math.min(82,Math.floor(r*166-.5))));u=(h+1)/166,n+=w(h,1)}else u=1,n+=w(0,1);return n+=w($(d),4),m.forEach(r=>{n+=w(O(r,u),2)}),n},S=U;var T={x:4,y:3},D={width:32,height:32},F=new Map,j=t=>{if(F.has(t))return F.get(t);let e=Promise.resolve(t);return F.set(t,e),e},W=t=>new Promise((e,a)=>{let i=new Image;i.onload=()=>e(i),i.onerror=(...s)=>a(s),i.crossOrigin="Anonymous",i.src=t}),J=t=>{let e=document.createElement("canvas");e.width=t.width,e.height=t.height;let a=e.getContext("2d");if(!a)throw new Error("[blurred-image] could not get canvas context");return a.drawImage(t,0,0),a.getImageData(0,0,t.width,t.height)},K=async t=>{let e=await W(t),a=J(e);return S(a.data,a.width,a.height,T.x,T.y)},N=(t,e)=>{let a=x(t,D.width,D.height),i=e.getContext("2d");i&&i.putImageData(new ImageData(a,D.width,D.height),0,0)};document.addEventListener("alpine:init",()=>{window.Alpine.data("blurredImage",t=>({thumbnailLink:t.thumbnailLink,link:t.link,element:t.element,fallbackLink:t.fallbackLink,isEagerLoaded:t.isEagerLoaded,isDisplayEnforced:t.isDisplayEnforced,imageDecoded:!1,imgLoaded:!1,imageFailed:!1,visible:!1,imageRequested:!1,imageSrc:null,finalVisible:!1,revealStarted:!1,blurhashReady:!1,blurhashFailed:!1,grayHoldDone:!1,blurhashHoldDone:!1,blurhashHoldTimer:null,showGray:!0,showBlurhash:!1,showImage:!1,fullIntersectFeasible:!0,fullIntersectSafetyMargin:96,resizeHandler:null,hashReadyEventDispatched:!1,revealEventDispatched:!1,init(){this.startGrayHold(),this.visible=this.isDisplayEnforced,this.evaluateFullIntersectionFeasibility(),this.resizeHandler=()=>this.evaluateFullIntersectionFeasibility(),window.addEventListener("resize",this.resizeHandler,{passive:!0}),this.$nextTick(()=>{this.generateBlurImage(this.thumbnailLink,this.element),(this.isDisplayEnforced||this.isEagerLoaded)&&this.requestImage()})},getTestIdForEvent(){var a,i,s,l,d;let e=(a=this.element)==null?void 0:a.closest("[data-testid]");return(i=e==null?void 0:e.dataset)!=null&&i.testid?e.dataset.testid:(d=(l=(s=this.element)==null?void 0:s.dataset)==null?void 0:l.testid)!=null?d:null},dispatchTestEvent(e,a={}){if(!this.element)return;let i={testId:this.getTestIdForEvent(),...a};i.testId&&typeof window!="undefined"&&(window.__blurredImageTestSignals=window.__blurredImageTestSignals||{},window.__blurredImageTestSignals[i.testId]=window.__blurredImageTestSignals[i.testId]||{},window.__blurredImageTestSignals[i.testId][e]=i),this.element.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:i}))},dispatchHashReadyEvent(){this.hashReadyEventDispatched||(this.hashReadyEventDispatched=!0,this.dispatchTestEvent("blurred-image:hash-ready",{blurhashReady:this.blurhashReady,blurhashFailed:this.blurhashFailed}))},dispatchRevealEvent(){this.revealEventDispatched||(this.revealEventDispatched=!0,this.dispatchTestEvent("blurred-image:revealed",{imageRequested:this.imageRequested,imageSrc:this.imageSrc,imageFailed:this.imageFailed,showImage:this.showImage,finalVisible:this.finalVisible}))},generateBlurImage:async function(e,a){try{let i=await K(e),s=a.querySelector("canvas");s instanceof HTMLCanvasElement?(N(i,s),this.blurhashReady=!0,this.startBlurhashHold()):(this.blurhashFailed=!0,this.startBlurhashHold()),this.dispatchHashReadyEvent(),this.updateVisibility()}catch(i){console.warn("[blurred-image] blurhash failed, falling back",i),this.blurhashFailed=!0,this.dispatchHashReadyEvent(),this.startBlurhashHold(),this.updateVisibility()}},startGrayHold:function(){window.setTimeout(()=>{this.grayHoldDone=!0,this.updateVisibility()},200)},startBlurhashHold:function(){this.blurhashHoldTimer||(this.blurhashHoldTimer=window.setTimeout(()=>{this.blurhashHoldDone=!0,this.updateVisibility()},600))},markVisible:function(e){if(this.isDisplayEnforced){this.visible=!0,this.updateVisibility(),this.requestImage();return}if(e){this.visible=!0,this.requestImage(),this.updateVisibility();return}this.finalVisible||(this.visible=!1,this.updateVisibility())},handlePartialEnter:function(){this.evaluateFullIntersectionFeasibility(),this.fullIntersectFeasible||this.markVisible(!0)},evaluateFullIntersectionFeasibility:function(){var i,s,l;let e=(s=(i=this.element)==null?void 0:i.getBoundingClientRect().height)!=null?s:0,a=(l=window.innerHeight)!=null?l:0;this.fullIntersectFeasible=e+this.fullIntersectSafetyMargin<=a},markLoaded:function(){this.imgLoaded=!0,this.updateVisibility()},handleImageError:function(e){var a;if(this.imageFailed&&((a=e==null?void 0:e.target)==null?void 0:a.src)===this.fallbackLink){this.markLoaded();return}if(this.imageFailed=!0,e!=null&&e.target&&e.target.src!==this.fallbackLink){e.target.src=this.fallbackLink;return}this.markLoaded()},requestImage:function(){this.imageRequested||!this.link||(this.imageRequested=!0,j(this.link).then(e=>{this.imageDecoded=!0,this.imageSrc=e,this.updateVisibility()}).catch(e=>{console.warn("[blurred-image] request failed",e),F.delete(this.link),this.imageFailed=!0,this.imageDecoded=!0,this.imageSrc=this.fallbackLink,this.updateVisibility()}))},updateVisibility:function(){this.showGray=!this.grayHoldDone||!this.blurhashReady&&!this.blurhashFailed,this.showBlurhash=this.blurhashReady&&this.grayHoldDone&&!this.revealStarted;let e=this.imgLoaded||this.imageFailed,a=this.visible||this.isDisplayEnforced||this.isEagerLoaded,i=!this.revealStarted&&(this.blurhashReady||this.blurhashFailed)&&this.blurhashHoldDone&&e&&(this.visible||this.isDisplayEnforced);!this.imageRequested&&a&&this.requestImage(),i&&(this.revealStarted=!0,this.finalVisible=!0,this.showGray=!1,this.showImage||(this.showImage=!0),this.dispatchRevealEvent(),window.requestAnimationFrame(()=>{this.showBlurhash=!1}))}}))});})();
